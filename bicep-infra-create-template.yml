
parameters:
  - name: serviceConnectionName
    displayName: "Service Connection Name"
    type: string
    default: "biceparmconnection"

  - name: environment
    displayName: "Environment"
    type: string
    default: "dev"
    values:
      - dev
      - test
      - prod

  - name: deploymentLocation
    displayName: "Deployment Location"
    type: string
    default: "swedencentral"

  - name: resourceGroupName
    displayName: "Resource Group Name"
    type: string
    default: ""

  - name: useEnvironmentSuffix
    displayName: "Use Environment Suffix (e.g. rg-team-bicep-dev)"
    type: boolean
    default: true

  - name: templateFileName
    displayName: "Template File Name"
    type: string
    default: $(System.DefaultWorkingDirectory)/infra/main.bicep

  - name: parametersFileName
    displayName: "Parameters File Name"
    type: string
    default: $(System.DefaultWorkingDirectory)/infra/main.prod.bicepparam

  - name: backendImage
    type: string
    default: crteambicepprod.azurecr.io/teambicep/backend:$(Build.BuildNumber)
  
  - name: frontendImage
    type: string
    default: crteambicepprod.azurecr.io/teambicep/frontend:$(Build.BuildNumber)

  - name: frontendRevisionSuffix
    type: string
    default: $(Build.BuildId)

  - name: backendRevisionSuffix
    type: string
    default: $(Build.BuildId)

jobs:
  - job:
    displayName: "Deploy Azure IaC with Bicep"
    steps:
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: "Deploy Bicep Template to Azure"
        inputs:
          deploymentScope: "Resource Group"
          connectedServiceName: ${{ parameters.serviceConnectionName }}
          action: "Create Or Update Resource Group"
          resourceGroupName: ${{ iif(parameters.useEnvironmentSuffix, format('{0}-{1}', variables.resourceGroupName, variables.environment), variables.resourceGroupName) }}
          location: ${{ parameters.deploymentLocation }}
          templateLocation: "Linked artifact"
          csmFile: ${{ parameters.templateFileName }}
          csmParametersFile: ${{ parameters.parametersFileName }}
          deploymentName: $(Build.BuildNumber)
          deploymentMode: "Incremental"
          overrideParameters: >
            -frontendOverrides {"frontendImageName":"${{ parameters.frontendImage }}","frontendRevisionSuffix":"${{ parameters.frontendRevisionSuffix }}"}
            -backendOverrides  {"backendImageName":"${{ parameters.backendImage }}","backendRevisionSuffix":"${{ parameters.backendRevisionSuffix }}"}

