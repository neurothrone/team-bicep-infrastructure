trigger: none

pool:
  vmImage: ubuntu-latest

resources:
  repositories:

    - repository: infra
      type: git
      name: team-bicep-infrastructure
      ref: refs/heads/main
           
    - repository: Backend
      type: git
      name: team-bicep-backend
      ref: refs/heads/main
      trigger:
        branches:
          include:
            - main
    
    - repository: Frontend
      type: git
      name: team-bicep-frontend
      ref: refs/heads/main
      trigger:
        branches:
          include:
            - main

stages:

- stage: Backend
  displayName: 'Backend'
  jobs:
  - template: DockerBuildAndPush-template.yml@infra
    parameters:
      projectName: 'TeamBicep.WebApi'
      dockerfilePath: 'src/TeamBicep.WebApi/Dockerfile'
      contextPath: 'src/TeamBicep.WebApi'
      imageRepository: 'TeamBicep/Backend'

- stage:
  displayName: 'Build Infra'
  dependsOn: Backend
  jobs:
  - template: bicep-infra-create-template.yml@infra
    parameters:
      environment: 'prod'
      serviceConnectionName: 'biceparmconnection'
      resourceGroupName: 'RG-dersimabbas'
      useEnvironmentSuffix: true
      deploymentLocation: 'swedencentral'
